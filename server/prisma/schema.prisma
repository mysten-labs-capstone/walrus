generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String
  privateKey   String?  // User's unique encryption key (hex) - optional for backward compatibility
  walletAddress String?
  balance      Float    @default(0.0)  // User's balance in USD
  createdAt    DateTime @default(now())
  
  // User's files
  files        File[]
  savedShares  SavedShare[]

  @@index([username])
}

model File {
  id                String   @id @default(uuid())
  
  // User ownership
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Encrypted user identifier (for master wallet lookups)
  encryptedUserId   String
  
  // Walrus blob info
  blobId            String   @unique
  blobObjectId      String?  // Sui object ID for extending blob storage
  
  // S3 intermediate storage (for async uploads)
  s3Key             String?  // S3 object key if using async upload mode
  status            String?  // Upload status: pending | processing | completed | failed
  
  // File metadata
  filename          String
  originalSize      Int
  contentType       String?
  epochs            Int      @default(3)  // Storage duration in epochs (30-day periods)
  
  // Encryption info
  encrypted         Boolean  @default(false)
  userKeyEncrypted  Boolean  @default(false)  // Encrypted with user's key
  masterKeyEncrypted Boolean @default(false)  // Encrypted with master backup key
  
  // Cache info
  cached            Boolean  @default(false)
  cacheKey          String?  // Path in file system cache
  cacheSize         Int?     // Size of cached file
  
  // Timestamps
  uploadedAt        DateTime @default(now())
  lastAccessedAt    DateTime @default(now())
  cachedAt          DateTime?
  
  @@index([userId])
  @@index([blobId])
  @@index([encryptedUserId])
  @@index([uploadedAt])
}

model SavedShare {
  id                String   @id @default(uuid())
  
  // User who saved this share
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Share reference
  shareId           String
  
  // File metadata
  blobId            String
  filename          String
  originalSize      Int
  contentType       String?
  
  // Original uploader info
  uploadedBy        String
  uploadedByUsername String
  
  // Timestamps
  savedAt           DateTime @default(now())
  lastAccessedAt    DateTime @default(now())
  
  @@index([userId])
  @@index([shareId])
  @@unique([userId, shareId])
}