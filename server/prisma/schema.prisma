generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                      String           @id @default(uuid())
  username                String           @unique
  passwordHash            String?
  walletAddress           String?
  balance                 Float            @default(0.0)
  createdAt               DateTime         @default(now())
  encryptedRecoveryPhrase String?
  authKeyHash             String?
  salt                    String?
  encryptedMasterKey      String?
  files                   File[]
  folders                 Folder[]
  recoveryTokens          RecoveryToken[]
  SavedShare              SavedShare[]
  transactions            Transaction[]

  @@index([username])
}

model File {
  id                 String    @id @default(uuid())
  userId             String
  encryptedUserId    String
  blobId             String    @unique
  blobObjectId       String?
  s3Key              String?
  status             String?
  fileId             String?   @unique // Blockchain file identifier (32-byte hex from encrypted blob)
  filename           String
  originalSize       Int
  contentType        String?
  epochs             Int       @default(3)
  encrypted          Boolean   @default(false)
  userKeyEncrypted   Boolean   @default(false)
  masterKeyEncrypted Boolean   @default(false)
  cached             Boolean   @default(false)
  cacheKey           String?
  cacheSize          Int?
  uploadedAt         DateTime  @default(now())
  lastAccessedAt     DateTime  @default(now())
  cachedAt           DateTime?
  expiresAt          DateTime?
  folderId           String?
  starred            Boolean   @default(false)
  expiresAt          DateTime?
  folder             Folder?   @relation(fields: [folderId], references: [id])
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares             Share[]

  @@index([userId])
  @@index([blobId])
  @@index([encryptedUserId])
  @@index([uploadedAt])
  @@index([folderId])
  @@index([fileId])
}

model Folder {
  id        String   @id @default(uuid())
  userId    String
  parentId  String?
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  files     File[]
  parent    Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[] @relation("FolderHierarchy")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([parentId])
}

model Share {
  id            String    @id @default(uuid())
  fileId        String
  blobId        String
  createdBy     String
  createdAt     DateTime  @default(now())
  expiresAt     DateTime?
  maxDownloads  Int?
  downloadCount Int       @default(0)
  revokedAt     DateTime?
  file          File      @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([blobId])
  @@index([createdBy])
  @@index([createdAt])
}

model SavedShare {
  id                 String   @id @default(uuid())
  shareId            String
  blobId             String
  filename           String
  originalSize       Int
  contentType        String?
  uploadedBy         String
  uploadedByUsername String
  savedAt            DateTime @default(now())
  lastAccessedAt     DateTime @default(now())
  userId             String
  User               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, shareId])
  @@index([shareId])
  @@index([userId])
}

model RecoveryToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Transaction {
  id           String   @id @default(uuid())
  userId       String
  amount       Float
  currency     String   @default("USD")
  type         String
  description  String?
  reference    String?
  balanceAfter Float?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}
