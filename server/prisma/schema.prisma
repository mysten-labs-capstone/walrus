generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String
  privateKey   String?  // User's unique encryption key (hex) - optional for backward compatibility
  walletAddress String?
  balance      Float    @default(0.0)  // User's balance in USD
  createdAt    DateTime @default(now())
  
  // User's files
  files        File[]
  // Security answers for account recovery
  securityAnswers SecurityAnswer[]
  // Recovery tokens issued during password reset flow
  recoveryTokens  RecoveryToken[]
  // User transactions (credits / debits)
  transactions    Transaction[]

  @@index([username])
}

model File {
  id                String   @id @default(uuid())
  
  // User ownership
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Encrypted user identifier (for master wallet lookups)
  encryptedUserId   String
  
  // Walrus blob info
  blobId            String   @unique
  blobObjectId      String?  // Sui object ID for extending blob storage
  
  // S3 intermediate storage (for async uploads)
  s3Key             String?  // S3 object key if using async upload mode
  status            String?  // Upload status: pending | processing | completed | failed
  
  // File metadata
  filename          String
  originalSize      Int
  contentType       String?
  epochs            Int      @default(3)  // Storage duration in epochs (30-day periods)
  
  // Encryption info
  encrypted         Boolean  @default(false)
  userKeyEncrypted  Boolean  @default(false)  // Encrypted with user's key
  masterKeyEncrypted Boolean @default(false)  // Encrypted with master backup key
  wrappedFileKey    String?  // Per-file encryption key wrapped by account master key (base64)
  
  // Cache info
  cached            Boolean  @default(false)
  cacheKey          String?  // Path in file system cache
  cacheSize         Int?     // Size of cached file
  
  // Timestamps
  uploadedAt        DateTime @default(now())
  lastAccessedAt    DateTime @default(now())
  cachedAt          DateTime?
  
  // Shares
  shares            Share[]
  
  @@index([userId])
  @@index([blobId])
  @@index([encryptedUserId])
  @@index([uploadedAt])
}

model Share {
  id                String    @id @default(uuid())
  
  // Linked file
  fileId            String
  file              File      @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  // Walrus blob info (denormalized for quick access)
  blobId            String
  
  // Share metadata
  createdBy         String    // userId who created the share
  createdAt         DateTime  @default(now())
  
  // Access policies
  expiresAt         DateTime? // Optional expiration timestamp
  maxDownloads      Int?      // Optional download limit
  downloadCount     Int       @default(0)
  revokedAt         DateTime? // If set, share is revoked
  
  @@index([fileId])
  @@index([blobId])
  @@index([createdBy])
  @@index([createdAt])
}

model SecurityAnswer {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question   String
  answerHash String
  createdAt  DateTime @default(now())

  @@index([userId])
}

model RecoveryToken {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String   @unique
  expiresAt  DateTime
  used       Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([userId])
}

model Transaction {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Positive for credits (add funds), negative for debits (payments)
  amount       Float
  currency     String   @default("USD")
  type         String   // e.g. 'credit' | 'debit' | 'refund'
  description  String?
  reference    String?  // external reference (stripe session id, refund id, etc.)
  balanceAfter Float?   // user's balance after this transaction
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
}