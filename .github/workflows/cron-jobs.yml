name: Scheduled Backend Jobs

on:
  schedule:
    # Trigger pending uploads - every 5 minutes
    - cron: "*/5 * * * *"
    # Cleanup old S3 files - every 6 hours
    - cron: "0 */6 * * *"
    # Retry failed uploads - every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  trigger-pending-uploads:
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/5 * * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Trigger Pending Uploads
        run: |
          curl -X POST https://walrus-jpfl.onrender.com/api/upload/trigger-pending

  cleanup-old-s3-files:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 */6 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Cleanup Old S3 Files
        run: |
          curl -X POST https://walrus-jpfl.onrender.com/api/cleanup/s3-old-files

  retry-failed-uploads:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 */6 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Retry Failed Uploads
        run: |
          curl -X POST https://walrus-jpfl.onrender.com/api/upload/retry-failed
